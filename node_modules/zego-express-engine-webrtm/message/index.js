!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s,r=t();for(s in r)("object"==typeof exports?exports:e)[s]=r[s]}}("undefined"!=typeof self?self:this,(function(){return t={1:function(e,t,s){var r=function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=null;try{t=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(e){}function s(e,t,s){this.low=0|e,this.high=0|t,this.unsigned=!!s}function r(e){return!0===(e&&e.__isLong__)}function i(e){var t=Math.clz32(e&-e);return e?31-t:t}Object.defineProperty(s.prototype,"__isLong__",{value:!0}),s.isLong=r;var o={},n={};function a(e,t){var s,r,i;return t?(i=0<=(e>>>=0)&&e<256)&&(r=n[e])?r:(s=h(e,0,!0),i&&(n[e]=s),s):(i=-128<=(e|=0)&&e<128)&&(r=o[e])?r:(s=h(e,e<0?-1:0,!1),i&&(o[e]=s),s)}function g(e,t){if(isNaN(e))return t?R:f;if(t){if(e<0)return R;if(l<=e)return I}else{if(e<=-M)return p;if(M<=e+1)return y}return e<0?g(-e,t).neg():h(e%_|0,e/_|0,t)}function h(e,t,r){return new s(e,t,r)}s.fromInt=a,s.fromNumber=g,s.fromBits=h;var m=Math.pow;function d(e,t,s){if(0===e.length)throw Error("empty string");if(t="number"==typeof t?(s=t,!1):!!t,"NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return t?R:f;if((s=s||10)<2||36<s)throw RangeError("radix");var r;if(0<(r=e.indexOf("-")))throw Error("interior hyphen");if(0===r)return d(e.substring(1),t,s).neg();for(var i=g(m(s,8)),o=f,n=0;n<e.length;n+=8){var a=Math.min(8,e.length-n),h=parseInt(e.substring(n,n+a),s);o=a<8?(a=g(m(s,a)),o.mul(a).add(g(h))):(o=o.mul(i)).add(g(h))}return o.unsigned=t,o}function u(e,t){return"number"==typeof e?g(e,t):"string"==typeof e?d(e,t):h(e.low,e.high,"boolean"==typeof t?t:e.unsigned)}s.fromString=d,s.fromValue=u;var _=4294967296,l=_*_,M=l/2,c=a(1<<24),f=a(0),R=(s.ZERO=f,a(0,!0)),E=(s.UZERO=R,a(1)),S=(s.ONE=E,a(1,!0)),T=(s.UONE=S,a(-1)),y=(s.NEG_ONE=T,h(-1,2147483647,!1)),I=(s.MAX_VALUE=y,h(-1,-1,!0)),p=(s.MAX_UNSIGNED_VALUE=I,h(0,-2147483648,!1)),v=(s.MIN_VALUE=p,s.prototype);return v.toInt=function(){return this.unsigned?this.low>>>0:this.low},v.toNumber=function(){return this.unsigned?(this.high>>>0)*_+(this.low>>>0):this.high*_+(this.low>>>0)},v.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";var t,s;if(this.isNegative())return this.eq(p)?(s=g(e),s=(t=this.div(s)).mul(s).sub(this),t.toString(e)+s.toInt().toString(e)):"-"+this.neg().toString(e);for(var r=g(m(e,6),this.unsigned),i=this,o="";;){var n=i.div(r),a=(i.sub(n.mul(r)).toInt()>>>0).toString(e);if((i=n).isZero())return a+o;for(;a.length<6;)a="0"+a;o=""+a+o}},v.getHighBits=function(){return this.high},v.getHighBitsUnsigned=function(){return this.high>>>0},v.getLowBits=function(){return this.low},v.getLowBitsUnsigned=function(){return this.low>>>0},v.getNumBitsAbs=function(){if(this.isNegative())return this.eq(p)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;0<t&&0==(e&1<<t);t--);return 0!=this.high?t+33:t+1},v.isZero=function(){return 0===this.high&&0===this.low},v.eqz=v.isZero,v.isNegative=function(){return!this.unsigned&&this.high<0},v.isPositive=function(){return this.unsigned||0<=this.high},v.isOdd=function(){return 1==(1&this.low)},v.isEven=function(){return 0==(1&this.low)},v.equals=function(e){return r(e)||(e=u(e)),(this.unsigned===e.unsigned||this.high>>>31!=1||e.high>>>31!=1)&&this.high===e.high&&this.low===e.low},v.eq=v.equals,v.notEquals=function(e){return!this.eq(e)},v.neq=v.notEquals,v.ne=v.notEquals,v.lessThan=function(e){return this.comp(e)<0},v.lt=v.lessThan,v.lessThanOrEqual=function(e){return this.comp(e)<=0},v.lte=v.lessThanOrEqual,v.le=v.lessThanOrEqual,v.greaterThan=function(e){return 0<this.comp(e)},v.gt=v.greaterThan,v.greaterThanOrEqual=function(e){return 0<=this.comp(e)},v.gte=v.greaterThanOrEqual,v.ge=v.greaterThanOrEqual,v.compare=function(e){if(r(e)||(e=u(e)),this.eq(e))return 0;var t=this.isNegative(),s=e.isNegative();return t&&!s?-1:!t&&s?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},v.comp=v.compare,v.negate=function(){return!this.unsigned&&this.eq(p)?p:this.not().add(E)},v.neg=v.negate,v.add=function(e){r(e)||(e=u(e));var t=this.high>>>16,s=65535&this.high,i=this.low>>>16,o=65535&this.low,n=e.high>>>16,a=65535&e.high,g=e.low>>>16,m=0,d=0,_=0,l=0;return d+=(_=_+((l+=o+(65535&e.low))>>>16)+(i+g))>>>16,h((_&=65535)<<16|(l&=65535),((m+=(d+=s+a)>>>16)+(t+n)&65535)<<16|(d&=65535),this.unsigned)},v.subtract=function(e){return r(e)||(e=u(e)),this.add(e.neg())},v.sub=v.subtract,v.multiply=function(e){if(this.isZero())return this;if(r(e)||(e=u(e)),t)return h(t.mul(this.low,this.high,e.low,e.high),t.get_high(),this.unsigned);if(e.isZero())return this.unsigned?R:f;if(this.eq(p))return e.isOdd()?p:f;if(e.eq(p))return this.isOdd()?p:f;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(c)&&e.lt(c))return g(this.toNumber()*e.toNumber(),this.unsigned);var s=this.high>>>16,i=65535&this.high,o=this.low>>>16,n=65535&this.low,a=e.high>>>16,m=65535&e.high,d=e.low>>>16,_=0,l=0,M=0,E=(E=0)+((l=l+((M+=n*(e=65535&e.low))>>>16)+o*e)>>>16)+((l=(65535&l)+n*d)>>>16);return h((l&=65535)<<16|(M&=65535),((_+=(E+=i*e)>>>16)+((E=(65535&E)+o*d)>>>16)+((E=(65535&E)+n*m)>>>16)+(s*e+i*d+o*m+n*a)&65535)<<16|(E&=65535),this.unsigned)},v.mul=v.multiply,v.divide=function(e){if((e=r(e)?e:u(e)).isZero())throw Error("division by zero");var s,i,o;if(t)return this.unsigned||-2147483648!==this.high||-1!==e.low||-1!==e.high?h((this.unsigned?t.div_u:t.div_s)(this.low,this.high,e.low,e.high),t.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?R:f;if(this.unsigned){if((e=e.unsigned?e:e.toUnsigned()).gt(this))return R;if(e.gt(this.shru(1)))return S;i=R}else{if(this.eq(p))return e.eq(E)||e.eq(T)?p:e.eq(p)?E:(o=this.shr(1).div(e).shl(1)).eq(f)?e.isNegative()?E:T:(s=this.sub(e.mul(o)),o.add(s.div(e)));if(e.eq(p))return this.unsigned?R:f;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();i=f}for(s=this;s.gte(e);){o=Math.max(1,Math.floor(s.toNumber()/e.toNumber()));for(var n=Math.ceil(Math.log(o)/Math.LN2),a=n<=48?1:m(2,n-48),d=g(o),_=d.mul(e);_.isNegative()||_.gt(s);)_=(d=g(o-=a,this.unsigned)).mul(e);d.isZero()&&(d=E),i=i.add(d),s=s.sub(_)}return i},v.div=v.divide,v.modulo=function(e){return r(e)||(e=u(e)),t?h((this.unsigned?t.rem_u:t.rem_s)(this.low,this.high,e.low,e.high),t.get_high(),this.unsigned):this.sub(this.div(e).mul(e))},v.mod=v.modulo,v.rem=v.modulo,v.not=function(){return h(~this.low,~this.high,this.unsigned)},v.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},v.clz=v.countLeadingZeros,v.countTrailingZeros=function(){return this.low?i(this.low):i(this.high)+32},v.ctz=v.countTrailingZeros,v.and=function(e){return r(e)||(e=u(e)),h(this.low&e.low,this.high&e.high,this.unsigned)},v.or=function(e){return r(e)||(e=u(e)),h(this.low|e.low,this.high|e.high,this.unsigned)},v.xor=function(e){return r(e)||(e=u(e)),h(this.low^e.low,this.high^e.high,this.unsigned)},v.shiftLeft=function(e){return r(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?h(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):h(0,this.low<<e-32,this.unsigned)},v.shl=v.shiftLeft,v.shiftRight=function(e){return r(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?h(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):h(this.high>>e-32,0<=this.high?0:-1,this.unsigned)},v.shr=v.shiftRight,v.shiftRightUnsigned=function(e){return r(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?h(this.low>>>e|this.high<<32-e,this.high>>>e,this.unsigned):h(32===e?this.high:this.high>>>e-32,0,this.unsigned)},v.shru=v.shiftRightUnsigned,v.shr_u=v.shiftRightUnsigned,v.rotateLeft=function(e){var t;return r(e)&&(e=e.toInt()),0==(e&=63)?this:32===e?h(this.high,this.low,this.unsigned):e<32?h(this.low<<e|this.high>>>(t=32-e),this.high<<e|this.low>>>t,this.unsigned):h(this.high<<(e-=32)|this.low>>>(t=32-e),this.low<<e|this.high>>>t,this.unsigned)},v.rotl=v.rotateLeft,v.rotateRight=function(e){var t;return r(e)&&(e=e.toInt()),0==(e&=63)?this:32===e?h(this.high,this.low,this.unsigned):e<32?h(this.high<<(t=32-e)|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned):h(this.low<<(t=32-(e-=32))|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned)},v.rotr=v.rotateRight,v.toSigned=function(){return this.unsigned?h(this.low,this.high,!1):this},v.toUnsigned=function(){return this.unsigned?this:h(this.low,this.high,!0)},v.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},v.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24,255&e,e>>>8&255,e>>>16&255,e>>>24]},v.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,255&e,t>>>24,t>>>16&255,t>>>8&255,255&t]},s.fromBytes=function(e,t,r){return r?s.fromBytesLE(e,t):s.fromBytesBE(e,t)},s.fromBytesLE=function(e,t){return new s(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},s.fromBytesBE=function(e,t){return new s(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)},e.default=s,"default"in e?e.default:e}({});void 0!==(t=function(){return r}.apply(t,[]))&&(e.exports=t)},23:function(e,t,s){"use strict";function r(e){return e}function i(e){return e}function o(e){return e}s.r(t),(m=n=n||{}).RTM_SEND_CUSTOM="zm.scc",m.RTM_SEND_BCM="zm.sbcm",m.RTM_SEND_RLM="zm.srlm",m.RTM_SEND_BRM="zm.sbrm",m.RTM_SEND_RAM="zm.sram",m.MESSAGE_SEND_RELIABLE="zm.msg.sdr",m.MESSAGE_FETCH_RELIABLE="zm.msg.frm",m.MESSAGE_RELIABLE_RSP="zm.msg.rlr",m.MESSAGE_RELIABLE_PUSH="zm.msg.rps",m.MESSAGE_SEND_ROOM_MSG="zm.msg.srm",m.MESSAGE_SEND_CUSTOM_MSG="zm.msg.scm",m.MESSAGE_SEND_BIG_MSG="zm.msg.sbm",m.MESSAGE_BIG_MSG_PUSH="zm.msg.bps",m.MESSAGE_SEND_RELAY_MSG="zm.msg.slm",m.SERVICE_PUSH="zm.sv.ps";var n,a,g={INPUT_PARAM:{code:1100001,msg:"input parm error."},TIMEOUT:{code:1100002,msg:"network timeout."},NOT_LOGIN:{code:1000002,msg:"not login"},IM_CONTENT_NULL:{code:1009001,msg:"message content is empty"},IM_CONTENT_TOO_LONG:{code:1009002,msg:"message content is too long"},IM_SEND_FAILED:{code:1009010,msg:"failed to send message"},ROOM_NOT_EXIST:{code:1002014,msg:"room not exist"},ROOM_INNER_ERROR:{code:1002099,msg:"room inner error"},TRANS_FREQUENTLY:{code:1102022,msg:"trans send frequently"},FREQ_LIMITED:{code:1109001,msg:"frequency limited."}},h={kZMLoginRoom:{event:"/sdk/login"},kZMLiveSendRoomBigIM:{event:"/liveroom/send_big_room_message",room_sid_string:r,error:{INPUT_PARAM:g.INPUT_PARAM,IM_CONTENT_NULL:g.IM_CONTENT_NULL,IM_CONTENT_TOO_LONG:g.IM_CONTENT_TOO_LONG,ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomSendCustomCommand:{event:"/liveroom/send_custom_command",room_sid_string:r,request_id:i,error:{INPUT_PARAM:g.INPUT_PARAM,IM_CONTENT_NULL:g.IM_CONTENT_NULL,IM_CONTENT_TOO_LONG:g.IM_CONTENT_TOO_LONG,ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomSendRoomMessage:{event:"/liveroom/send_room_message",room_id:i,room_sid_string:i,msg_content_size:o,send_seq:o,msg_id:o,error:{INPUT_PARAM:g.INPUT_PARAM,IM_CONTENT_NULL:g.IM_CONTENT_NULL,IM_CONTENT_TOO_LONG:g.IM_CONTENT_TOO_LONG,ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomSendRoomExtraInfo:{event:"/liveroom/set_room_extrainfo",room_id:i,room_sid_string:r,key:i,value:i,error:{INPUT_PARAM:g.INPUT_PARAM,TRANS_FREQUENTLY:g.TRANS_FREQUENTLY,ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomGetRoomExtraInfo:{event:"/liveroom/get_room_extrainfo",fetch_array:r,result_array:r,error:{INPUT_PARAM:g.INPUT_PARAM,TRANS_FREQUENTLY:g.TRANS_FREQUENTLY,ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomRecvRoomExtraInfo:{event:"/liveroom/recv_room_extrainfo",trans_type:i,trans_seq:o,error:{ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMLiveRecvRoomBigIM:{event:"/liveroom/recv_big_room_message",error:{ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomGetRoomMessage:{event:"/liveroom/recv_room_message",error:{ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}},kZMRoomRecvCustomCommand:{event:"/liveroom/recv_custom_command",error:{ROOM_NOT_EXIST:g.ROOM_NOT_EXIST}}},m=((m=a=a||{})[m.I=0]="I",m[m.H=10]="H",m[m.M=100]="M",m[m.L=1e3]="L",s(1)),d=s.n(m),u=(_.prototype.loginRsp=function(e){var t,s=this;if(null!=e.body.ret_timestamp&&"string"==typeof e.body.ret_timestamp&&(t=parseFloat(e.body.ret_timestamp),this.serverTimeOffset=0==t?0:e.body.ret_timestamp-(new Date).getTime()),e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.datiTimeWindow=e.body.dati_time_window),e.body.trans_seqs)for(var r=0;r<e.body.trans_seqs.length;r++){var i=e.body.trans_seqs[r].trans_channel,o=e.body.trans_seqs[r].trans_seq_array;0<(o=(o=o.filter((function(e){var t=e.trans_type;e=e.trans_seq;return!s.transSeqMap[t]||s.transSeqMap[t].seq<e}))).map((function(e){return{trans_type:e.trans_type,trans_local_seq:e.trans_seq}}))).length&&this.fetchReliableMessage(i,o)}},_.prototype.sendReliableMessage=function(e,t,s,r){var i=this;this.logger.info(n.MESSAGE_SEND_RELIABLE+" call"),this.room.isLogin()?this.isReliable?(this.logger.error(n.MESSAGE_SEND_RELIABLE+" send too often"),r(h.kZMRoomSendRoomExtraInfo.error.TRANS_FREQUENTLY)):(this.transSeqMap[e]||(this.transSeqMap[e]={seq:0}),t={trans_type:e,trans_data:t,trans_local_seq:this.transSeqMap[e].seq,trans_channel:"clt"},this.isReliable=!0,(this.stateCenter.useNetAgent?this.liveRoomHandler:this.service).sendReliableMessage(t,(function(t){i.transSeqMap[e].seq=t.body.trans_seq,i.logger.info(n.MESSAGE_SEND_RELIABLE+" trans "+e+" seq "+t.body.trans_seq),i.isReliable=!1,s({seq:t.header.seq,errorCode:0})}),(function(e){var t=g.ROOM_INNER_ERROR;e.body&&e.body.err_code?(t=i.rtm.getServerError(e.body.err_code),i.logger.error(n.MESSAGE_SEND_ROOM_MSG+"  "+t.msg)):t=e,i.isReliable=!1,r(t)}),this.room)):(this.logger.error(n.MESSAGE_SEND_RELIABLE+" state error"),r&&r(g.NOT_LOGIN))},_.prototype.fetchReliableMessage=function(e,t){function s(e){r.handleFetchTransRsp(e,i)}var r=this,i=(e={trans_channel:e,fetch_array:t},this.stateCenter.reporter.createSpan(a.H,{key:h.kZMLoginRoom.event,par:this.room.roomID},{key:""},h.kZMRoomGetRoomExtraInfo.event));i.setAttributes({fetch_array:h.kZMRoomGetRoomExtraInfo.fetch_array(t)}),(this.stateCenter.useNetAgent?this.liveRoomHandler:this.service).fetchReliableMessage(e,s,s,this.room),this.logger.info(n.MESSAGE_FETCH_RELIABLE+" call success")},_.prototype.handleFetchTransRsp=function(e,t){if(e.body&&0!=e.body.err_code)this.logger.error(n.MESSAGE_RELIABLE_RSP+" trans send error "+e.body.err_code),this.stateCenter.tracer.setError(t,{code:e.body.err_code});else if(e.header&&e.body){var s=e.body.trans_fetch_results,r=[],i=[];if(Array.isArray(s)&&0<s.length){for(var o=0;o<s.length;o++){var a,m,d=s[o];1000001109===d.err_code?this.logger.warn(n.MESSAGE_RELIABLE_RSP+" fetch trans unknown type "+d.err_code):(a=d.trans_type,m=d.trans_seq,i.push({trans_type:a,trans_seq:m}),1000001110===d.err_code?(this.logger.warn(n.MESSAGE_RELIABLE_RSP+" fetch trans seq is wrong "+d.err_code),this.transSeqMap[a]={seq:m}):!this.transSeqMap[a]||this.transSeqMap[a].seq<m?(this.transSeqMap[a]={seq:m},r.push(d)):this.logger.warn(n.MESSAGE_RELIABLE_RSP+" fetch trans seq wrong"))}0<r.length&&this.onRecvReliableMessage(r)}t.setAttributes({result_array:h.kZMRoomGetRoomExtraInfo.result_array(i)}),t.end()}else this.logger.error(n.MESSAGE_RELIABLE_RSP+" trans send error "+e),this.stateCenter.tracer.setError(t,g.TIMEOUT)},_.prototype.handlePushTransMsg=function(e){var t,s=e.body.trans_type,r=e.body.trans_seq;!this.transSeqMap[s]||this.transSeqMap[s].seq<r?(this.transSeqMap[s]={seq:r},(null==(t=null==e?void 0:e.body)?void 0:t.trans_idname)!==this.stateCenter.idName?this.onRecvReliableMessage([e.body]):this.logger.warn(n.MESSAGE_RELIABLE_PUSH+" id name same")):this.logger.warn(n.MESSAGE_RELIABLE_PUSH+" trans seq wrong"),this.logger.info(n.MESSAGE_RELIABLE_PUSH+" trans "+s+" seq "+r)},_.prototype.sendRoomMsg=function(e,t,s,r,i,o){var a=this;if(!this.room.isLogin())return this.logger.error(n.MESSAGE_SEND_ROOM_MSG+" state error"),o(g.NOT_LOGIN),!1;var m=Date.parse(new Date+"");return 0<this.sendRoomMsgTime&&this.sendRoomMsgTime+this.sendRoomMsgInterval>m?(this.logger.info(n.MESSAGE_SEND_ROOM_MSG+" freq error"),o&&o(g.FREQ_LIMITED,0,e,r),!1):(this.sendRoomMsgTime=m,m=(this.stateCenter.useNetAgent?this.liveRoomHandler:this.service).sendRoomMsg({msg_category:e,msg_type:1,msg_priority:1,msg_content:r},(function(e){i({seq:e.header.seq,errorCode:0,messageID:e.body.msg_id})}),(function(e){var t,s,r=g.ROOM_INNER_ERROR;e.header&&e.body?(s=(t=[a.rtm.getServerError(e.body.err_code),e.body.msg_id])[1],a.logger.error(n.MESSAGE_SEND_ROOM_MSG+"  "+(r=t[0]).msg),o({seq:e.header.seq,errorCode:(r=r==g.TIMEOUT?g.IM_SEND_FAILED:r).code,messageID:s})):(e.code&&e.msg&&(r=e),o({seq:0,errorCode:r.code,messageID:0}))}),this.room),this.stateCenter.reporter.spanSetAttributes({key:h.kZMRoomSendRoomMessage.event,par:null==(e=this.room)?void 0:e.roomID},{send_seq:h.kZMRoomSendRoomMessage.send_seq(m)}),this.logger.info(n.MESSAGE_SEND_ROOM_MSG+"  call success"),!0)},_.prototype.handlePushRoomMsg=function(e){this.stateCenter.useNetAgent?this.room.roomSessionID:e.header.session_id;var t,s=[];this.stateCenter.useNetAgent?(t=e.body.msg_data,e.body.msg_data.forEach((function(e){e={fromUser:{userID:e.id_name,userName:e.nick_name},message:e.msg_content,sendTime:e.send_time.toNumber(),messageID:e.msg_id.toNumber()},s.push(e)})),e.body.server_msg_id=e.body.server_msg_id.toNumber(),e.body.ret_msg_id=e.body.ret_msg_id.toNumber()):(t=e.body.chat_data,e.body.chat_data.forEach((function(e){e={fromUser:{userID:e.id_name,userName:e.nick_name},message:e.msg_content,sendTime:e.send_time,messageID:e.msg_id},s.push(e)}))),this.stateCenter.actionListener("IMRecvBroadcastMessage",this.room.roomID,s),this.stateCenter.actionListener("_recvRoomMsg",t,e.body.server_msg_id,e.body.ret_msg_id)},_.prototype.sendCustomCommand=function(e,t,s,r){var i=this;if(!this.room.isLogin())return this.logger.error(n.MESSAGE_SEND_CUSTOM_MSG+" state error"),r(g.NOT_LOGIN),!1;t={from_userid:this.stateCenter.idName,from_username:this.stateCenter.nickName,request_id:this.stateCenter.getRequestId(),custom_content:t||"",room_id:this.room.roomID};var o=(this.stateCenter.reporter.spanSetAttributes({key:h.kZMRoomSendCustomCommand.event,par:null==(o=this.room)?void 0:o.roomID},{request_id:h.kZMRoomSendCustomCommand.request_id(t.request_id)}),{dest_id_name:e,custom_msg:JSON.stringify(t)});return(this.stateCenter.useNetAgent?this.liveRoomHandler:this.service).sendCustomCommand(o,(function(e){s({seq:e.header.seq,errorCode:0})}),(function(e){var t,s=i.rtm.getServerError(e.body.err_code);i.logger.error(n.MESSAGE_SEND_CUSTOM_MSG+" "+s.msg),t=2===(null==(t=e.body)?void 0:t.err_code)?g.INPUT_PARAM:s==g.TIMEOUT?g.IM_SEND_FAILED:s,r({seq:e.header.seq,errorCode:t.code,code:t.code})}),this.room),this.logger.info(n.MESSAGE_SEND_CUSTOM_MSG+" call success"),!0},_.prototype.handlePushCustomMsg=function(e){e=[(e=JSON.parse(e.body.custommsg)).from_userid,e.from_username,e.room_id,e.custom_content],this.stateCenter.actionListener("IMRecvCustomCommand",e[2],{userID:e[0],userName:e[1]},e[3])},_.prototype.sendBigRoomMessage=function(e,t,s,r,i,o){var a,h,m,d,u=this;this.room.isLogin()?(a=this.bigimTimeWindow,h=this.serverTimeOffset,m=(new Date).getTime()+h,d=this.rtm.getSeq().toString(),this.bigImCallbackMap[d]={success:i,error:o},0==a?this.sendBigRoomMessageInternal([{msg_category:e,msg_type:1,msg_content:r,bigmsg_client_id:d}],(function(e){u.handleBigImMsgRsp(e)}),(function(e){o&&o(e)})):(i=Math.floor(m/a),this.bigImLastTimeIndex<i&&0==this.bigIMmessageList.length?(this.bigImLastTimeIndex=i,this.sendBigRoomMessageInternal([{msg_category:e,msg_type:1,msg_content:r,bigmsg_client_id:d}],(function(e){u.handleBigImMsgRsp(e)}),(function(e){o&&o(e)}))):(this.bigIMmessageList.push({msg_category:e,msg_type:1,msg_content:r,bigmsg_client_id:d}),1==this.bigIMmessageList.length&&this.setBigImTimer(h,a)))):(this.logger.error(n.MESSAGE_SEND_BIG_MSG+" state error"),o&&o(g.NOT_LOGIN))},_.prototype.sendBigRoomMessageInternal=function(e,t,s){(this.stateCenter.useNetAgent?this.liveRoomHandler:this.service).sendBigRoomMessage({msgs:e},(function(e){t(e)}),(function(e){var t=g.ROOM_INNER_ERROR;e.header&&e.body||(e.code&&e.msg&&(t=e),s(t)),s(t)}),this.room),this.logger.info(n.MESSAGE_SEND_BIG_MSG+" sendBigRoomMessage called")},_.prototype.handleBigImMsgRsp=function(e){this.bigimTimeWindow=e.body.bigim_time_window;for(var t=0;t<e.body.msgs.length;t++){var s,r=e.body.msgs[t].bigmsg_client_id,i=e.body.msgs[t].bigmsg_id;this.bigImCallbackMap[r]&&(null!=(s=this.bigImCallbackMap[r].success)&&s({seq:e.header.seq,errorCode:0,messageID:i}),delete this.bigImCallbackMap[r])}},_.prototype.setBigImTimer=function(e,t){var s=this;e=t-((new Date).getTime()+e)%t,t=this.rtm.generateRandumNumber(t)+e;this.bigImTimer=setTimeout((function(){s.onBigImTimer()}),t)},_.prototype.onBigImTimer=function(){for(var e=this,t=(new Date).getTime()+this.serverTimeOffset,s=(this.bigImLastTimeIndex=Math.floor(t/this.bigimTimeWindow),[]),r=[],i=0;i<this.bigIMmessageList.length&&!(20<=i);i++){var o=this.bigIMmessageList[i];s.push({msg_category:o.msg_category,msg_type:o.msg_type,msg_content:o.msg_content,bigmsg_client_id:o.bigmsg_client_id}),r.push(o.bigmsg_client_id)}20<this.bigIMmessageList.length?this.bigIMmessageList.splice(0,20):this.bigIMmessageList=[],this.sendBigRoomMessageInternal(s,(function(t){e.handleBigImMsgRsp(t)}),(function(t,s){for(var i=0;i<r.length;i++){var o=r[i],n=e.bigImCallbackMap[o];n&&(null!=n.error&&n.error(t,s),delete e.bigImCallbackMap[o])}})),this.bigImTimer&&clearTimeout(this.bigImTimer),this.bigImTimer=null,0<this.bigIMmessageList.length&&this.setBigImTimer(this.serverTimeOffset,this.bigimTimeWindow)},_.prototype.handlePushMergeMsg=function(e){for(var t=0;t<e.body.messages.length;t++)14001!==e.body.messages[t].sub_cmd&&"/lr/push/bigim_chat"!==e.body.messages[t].sub_cmd||this.handlePushBigRooMsg(e.body.messages[t].msg_body)},_.prototype.handlePushBigRooMsg=function(e){var t;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){return void this.logger.warn(n.MESSAGE_BIG_MSG_PUSH+"parse json error")}else t=e;if(t){e=t.room_id;for(var s=[],r=0;r<t.msg_data.length;r++){var i=t.msg_data[r];i.id_name==this.stateCenter.idName?this.logger.info(n.MESSAGE_BIG_MSG_PUSH+" self message"):s.push({idName:i.id_name,nickName:i.nick_name,messageId:i.bigmsg_id,category:i.msg_category,type:i.msg_type,content:i.msg_content,time:i.send_time||d.a.isLong(i.msg_timestamp)&&i.msg_timestamp.toNumber()})}0==s.length?this.logger.info(n.MESSAGE_BIG_MSG_PUSH+" no other pushData except self"):this.onRecvBigRoomMessage(s,e),this.logger.info(n.MESSAGE_BIG_MSG_PUSH+"call success")}else this.logger.warn(n.MESSAGE_BIG_MSG_PUSH+" cann't find message body")},_.prototype.onRecvBigRoomMessage=function(e,t){var s=[];e.forEach((function(e){e={fromUser:{userID:e.idName,userName:e.nickName},message:e.content,sendTime:e.time,messageID:e.messageId},s.push(e)})),this.stateCenter.actionListener("IMRecvBarrageMessage",t,s),this.stateCenter.actionListener("_recvBigRoomMessage",e,t)},_.prototype.resetMessageInfo=function(){this.transSeqMap={},this.realyMessageList=[],this.relayTimer&&(clearTimeout(this.relayTimer),this.relayTimer=null),this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImCallbackMap={},this.bigImTimer&&(clearTimeout(this.bigImTimer),this.bigImTimer=null),this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0},_.prototype.sendRelayMessage=function(e,t,s,r){var i=this.datiTimeWindow,o=this.serverTimeOffset;0<i?(this.realyMessageList.push({type:e,data:t,success:s,error:r}),1==this.realyMessageList.length&&this.setRelayTimer(o,i)):this.sendRelayMessageInternal(e,t,s,r)},_.prototype.sendRelayMessageInternal=function(e,t,s,r){var i=this;this.logger.info(n.MESSAGE_SEND_RELAY_MSG+" call"),e={relay_type:e,relay_data:t},t=this.room;(this.stateCenter.useNetAgent?this.liveRoomHandler:this.service).sendRelayMessage(e,(function(e){s&&s(e.header.seq,e.body.relay_result)}),(function(e){var t=g.ROOM_INNER_ERROR;e.header&&e.body?r&&r(i.rtm.getServerError(e.body.err_code),e.header.seq):(e.code&&e.msg&&(t=e),r&&r(t,0))}),t)},_.prototype.setRelayTimer=function(e,t){var s=this;e=(new Date).getTime()+e,e=this.rtm.generateRandumNumber(2*t-e%t);this.logger.info(n.MESSAGE_SEND_RELAY_MSG+" setTimer "+e),this.relayTimer=setTimeout((function(){s.onRelayTimer()}),e)},_.prototype.onRelayTimer=function(){var e;0==this.realyMessageList.length?this.logger.info(n.MESSAGE_SEND_RELAY_MSG+"  no relay data"):(e=this.realyMessageList[0],this.sendRelayMessageInternal(e.type,e.data,e.success,e.error),this.relayTimer&&clearTimeout(this.relayTimer),this.relayTimer=null,this.realyMessageList.splice(0,1),0<this.realyMessageList.length&&this.setRelayTimer(this.serverTimeOffset,this.datiTimeWindow))},_);function _(e,t,s,r,i,o,n){var a=this;this.logger=e,this.stateCenter=t,this.dataReport=s,this.service=r,this.liveRoomHandler=i,this.rtm=o,this.room=n,this.sendRoomMsgTime=0,this.sendRoomMsgInterval=500,this.bigImCallbackMap={},this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImTimer=null,this.relayTimer=null,this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0,this.isReliable=!1,this.transSeqMap={},this.onRecvReliableMessage=function(e){var t=e.map((function(e){return{key:e.trans_type,value:e.trans_data,updateUser:{userID:e.trans_idname,userName:e.trans_nickname},updateTime:d.a.isLong(e.trans_send_time)?e.trans_send_time.toNumber():e.trans_send_time}}));0<t.length&&a.stateCenter.actionListener("roomExtraInfoUpdate",a.room.roomID,t),e.forEach((function(e){a.stateCenter.actionListener("recvReliableMessage",e.trans_type,e.trans_seq,e.trans_data)}))},this.realyMessageList=[]}function l(e,t,s,r){var i=this;return void 0===s&&(s=1),void 0===r&&(r=1),new Promise((function(o,a){var g,m=i.getMsgSpan(h.kZMRoomSendRoomMessage.event,e,!0),d=(a=i.stateCenter.proxyRes(m,(function(e){m.setAttributes({msg_id:h.kZMRoomSendRoomMessage.msg_id(e.messageID)}),o(e)}),a)).interResolve;a=a.interReject;"string"!=typeof e||""==e?(i.logger.error(n.RTM_SEND_BCM+" roomid must be string and not empty"),a(h.kZMRoomSendRoomMessage.error.INPUT_PARAM," param roomID error")):void 0===t||""==t?(i.logger.error(n.RTM_SEND_BCM+" message is empty"),a(h.kZMRoomSendRoomMessage.error.IM_CONTENT_NULL)):"string"!=typeof t?(i.logger.error(n.RTM_SEND_BCM+" message must be string"),a(h.kZMRoomSendRoomMessage.error.INPUT_PARAM," param message error")):1024<t.length?(i.logger.error(n.RTM_SEND_BCM+" message too long"),a(h.kZMRoomSendRoomMessage.error.IM_CONTENT_TOO_LONG)):(g=i.getRoomModules(e),m.setAttributes({send_seq:h.kZMRoomSendRoomMessage.send_seq(),msg_content:t}),g?g.messageHandler.sendRoomMsg(s,r,e,t,(function(e){e.messageID&&m.setAttributes({msg_id:e.messageID}),d(e)}),a):a(h.kZMRoomSendRoomMessage.error.ROOM_NOT_EXIST))}))}function M(e,t,s){var r=this;return new Promise((function(i,o){var a,m,d=r.getMsgSpan(h.kZMRoomSendCustomCommand.event,e,!0);o=(i=r.stateCenter.proxyRes(d,i,o)).interResolve,i=i.interReject;"string"!=typeof e||""==e?(r.logger.error(n.RTM_SEND_CUSTOM+" roomid must be string and not empty"),i(g.INPUT_PARAM," param roomID error")):s instanceof Array&&!s.find((function(e){return"string"!=typeof e}))?"string"!=typeof t&&"object"!=typeof t?(r.logger.error(n.RTM_SEND_CUSTOM+" custom content must be a non empty string or object"),i(h.kZMRoomSendCustomCommand.error.INPUT_PARAM," param command error")):"string"==typeof t&&1024<t.length?(r.logger.error(n.RTM_SEND_CUSTOM+" command too long"),i(h.kZMRoomSendCustomCommand.error.IM_CONTENT_TOO_LONG)):(a=r.getRoomModules(e),m="string"==typeof t?t:JSON.stringify(t),d.setAttributes({msg_content:m}),a?a.messageHandler.sendCustomCommand(s,t,o,i):i(h.kZMRoomSendCustomCommand.error.ROOM_NOT_EXIST)):(r.logger.error(n.RTM_SEND_CUSTOM+" dstMembers must be string array"),i(h.kZMRoomSendCustomCommand.error.INPUT_PARAM," param toUserList error"))}))}function c(e,t,s,r){var i=this;return void 0===s&&(s=1),void 0===r&&(r=1),new Promise((function(o,a){var g=i.getMsgSpan(h.kZMLiveSendRoomBigIM.event,e);a=(o=i.stateCenter.proxyRes(g,o,a)).interResolve,o=o.interReject;"string"!=typeof e||""==e?(i.logger.error(n.RTM_SEND_BRM+"roomid must be string and not empty"),o(h.kZMLiveSendRoomBigIM.error.INPUT_PARAM," param roomID error")):void 0===t||""==t?(i.logger.error(n.RTM_SEND_BRM+" message is empty"),o(h.kZMLiveSendRoomBigIM.error.IM_CONTENT_NULL)):"string"!=typeof t?(i.logger.error(n.RTM_SEND_BRM+" message must be string"),o(h.kZMLiveSendRoomBigIM.error.INPUT_PARAM," param message error")):1024<t.length?(i.logger.error(n.RTM_SEND_BRM+" message too long"),o(h.kZMLiveSendRoomBigIM.error.IM_CONTENT_TOO_LONG)):(g.setAttributes({msg_content:t}),(g=i.getRoomModules(e))?g.messageHandler.sendBigRoomMessage(s,r,e,t,a,o):o(h.kZMLiveSendRoomBigIM.error.ROOM_NOT_EXIST))}))}function f(e,t,s){var r=this;return new Promise((function(i,o){var a=r.getMsgSpan(h.kZMRoomSendRoomExtraInfo.event,e);o=(i=r.stateCenter.proxyRes(a,i,o)).interResolve,i=i.interReject;"string"!=typeof e||""==e?(r.logger.error(n.RTM_SEND_BCM+" roomid must be string and not empty"),i(h.kZMRoomSendRoomMessage.error.INPUT_PARAM," param roomID error")):t&&"string"==typeof t?128<t.length?(r.logger.error(n.RTM_SEND_RLM+" type is too long"),i({errorCode:h.kZMRoomSendRoomExtraInfo.error.INPUT_PARAM.code})):s&&"string"==typeof s?4096<s.length?(r.logger.error(n.RTM_SEND_RLM+" type is too long"),i({errorCode:h.kZMRoomSendRoomExtraInfo.error.INPUT_PARAM.code})):(a.setAttributes({key:h.kZMRoomSendRoomExtraInfo.key(t),value:h.kZMRoomSendRoomExtraInfo.value(s)}),(a=r.getRoomModules(e))?a.messageHandler.sendReliableMessage(t,s,o,i):i(h.kZMRoomSendRoomExtraInfo.error.ROOM_NOT_EXIST)):(r.logger.error(n.RTM_SEND_RLM+" data must be string"),i({errorCode:h.kZMRoomSendRoomExtraInfo.error.INPUT_PARAM.code})):(r.logger.error(n.RTM_SEND_RLM+" type must be string"),i({errorCode:h.kZMRoomSendRoomExtraInfo.error.INPUT_PARAM.code}))}))}var R={_sendBroadcastMessage:l,sendBroadcastMessage:function(e,t){var s=this;return new Promise((function(r,i){l.call(s,e,t).then((function(e){r({errorCode:e.errorCode,messageID:e.messageID,extendedData:e.extendedData})})).catch((function(e){i(e)}))}))},_sendCustomCommand:M,sendCustomCommand:function(e,t,s){var r=this;return new Promise((function(i,o){M.call(r,e,t,s).then((function(e){i({errorCode:e.errorCode,extendedData:e.extendedData})})).catch((function(e){o(e)}))}))},_sendBarrageMessage:c,sendBarrageMessage:function(e,t){var s=this;return new Promise((function(r,i){c.call(s,e,t).then((function(e){r({errorCode:e.errorCode,messageID:e.messageID,extendedData:e.extendedData})})).catch((function(e){i(e)}))}))},_setRoomExtraInfo:f,setRoomExtraInfo:function(e,t,s){return f.call(this,e,t,s)},sendRelayMessage:function(e,t,s,r,i){(i=this.getRoomModules(i)||this.stateCenter.roomModulesList[0])?i.messageHandler.sendRelayMessage(e,t,s,r):r&&r(g.ROOM_NOT_EXIST,0)}},E={handlePushRoomMsg:function(e){var t=this.handlePushMsg(e),s=t[0];e=t[1];s.messageHandler.handlePushRoomMsg(e)},handlePushCustomMsg:function(e){var t=this.handlePushMsg(e),s=t[0];e=t[1];s.messageHandler.handlePushCustomMsg(e)},handlePushMergeMsg:function(e){var t=null==(t=null==e?void 0:e.header)?void 0:t.room_id;(t=this.rtm.getRoomModules(t))?t.messageHandler.handlePushMergeMsg(e):this.logger.error(n.SERVICE_PUSH+" room no found ignore "+JSON.stringify(e))},handlePushTransMsg:function(e){var t,s=(r=this.handlePushMsg(e))[0],r=null==(r=null==(e=r[1])?void 0:e.header)?void 0:r.room_id;(r=this.rtm.getMsgSpan(h.kZMRoomRecvRoomExtraInfo.event,r)).setAttributes({trans_type:h.kZMRoomRecvRoomExtraInfo.trans_type(null==(t=null==e?void 0:e.body)?void 0:t.trans_type),trans_seq:h.kZMRoomRecvRoomExtraInfo.trans_seq(null==(t=null==e?void 0:e.body)?void 0:t.trans_seq)}),r.end(),s.messageHandler.handlePushTransMsg(e)},handleBigImMsgRsp:function(e){var t=null==(t=null==e?void 0:e.header)?void 0:t.room_id;(t=this.rtm.getRoomModules(t))?t.messageHandler.handleBigImMsgRsp(e):this.logger.error(n.SERVICE_PUSH+" room no found ignore "+JSON.stringify(e))},handlePushMsg:function(e){var t=null==(t=null==e?void 0:e.header)?void 0:t.room_id;if(t=this.rtm.getRoomModules(t))return[t,e];this.logger.error(n.SERVICE_PUSH+" room no found ignore "+JSON.stringify(e))}},S={initMessageHandler:function(){this.messageHandler=new u(this.logger,this.stateCenter,this.dataReport,this.service,this.liveRoomHandler,this.rtm,this)}};t.default={type:"message",install:function(e,t,s,r){for(var i in R)Object.defineProperty(e.prototype,i,{value:R[i],writable:!1});for(var i in E)Object.defineProperty(s.prototype,i,{value:E[i],writable:!1}),Object.defineProperty(r.prototype,i,{value:E[i],writable:!1});for(var i in S)Object.defineProperty(t.prototype,i,{value:S[i],writable:!1})}}}},s={},e.m=t,e.c=s,e.d=function(t,s,r){e.o(t,s)||Object.defineProperty(t,s,{enumerable:!0,get:r})},e.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e.t=function(t,s){if(1&s&&(t=e(t)),8&s)return t;if(4&s&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&s&&"string"!=typeof t)for(var i in t)e.d(r,i,function(e){return t[e]}.bind(null,i));return r},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.p="",e(e.s=23);function e(r){if(s[r])return s[r].exports;var i=s[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var t,s}));